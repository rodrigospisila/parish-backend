// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  SYSTEM_ADMIN // Administrador do Sistema (Super Admin)
  DIOCESAN_ADMIN // Administrador Diocesano
  PARISH_ADMIN // Administrador Paroquial
  COMMUNITY_COORDINATOR // Coordenador de Comunidade
  PASTORAL_COORDINATOR // Coordenador de Pastoral/Ministério
  VOLUNTEER // Membro/Voluntário
  FAITHFUL // Fiel
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  DECEASED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
  COMMON_LAW_MARRIAGE
}

enum SacramentType {
  BAPTISM
  FIRST_COMMUNION
  CONFIRMATION
  MARRIAGE
  HOLY_ORDERS
  ANOINTING_OF_THE_SICK
}

enum EventType {
  MASS
  SACRAMENT
  PASTORAL_MEETING    // Reunião de Pastoral
  PASTORAL_ACTIVITY   // Atividade de Pastoral
  COMMUNITY_EVENT
  RETREAT
  FORMATION
  VISITATION
}

enum EventStatus {
  DRAFT // Rascunho
  PUBLISHED // Publicado
  CANCELLED // Cancelado
  COMPLETED // Concluído
}

enum RecurrenceType {
  DAILY      // Diário
  WEEKLY     // Semanal
  MONTHLY    // Mensal
  CUSTOM     // Personalizado (dias específicos)
}

enum MassScheduleType {
  MASS
  CONFESSION
  ADORATION
  ROSARY
}

enum IntentionType {
  THANKSGIVING
  SUFFRAGE
  SPECIAL
}

enum PrayerRequestCategory {
  HEALTH
  FAMILY
  WORK
  STUDIES
  OTHER
}

enum PrayerRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TransactionType {
  INCOME
  EXPENSE
}

enum NotificationType {
  URGENT_NOTICE
  SCHEDULE_REMINDER
  EVENT_REMINDER
  PRAYER_REQUEST
  MASS_INTENTION_CONFIRMED
  DAILY_LITURGY
  NEWS
}

// ============================================
// AUTHENTICATION & USERS
// ============================================

model User {
  id       String   @id @default(cuid())
  email    String   @unique
  password String
  name     String
  phone    String?
  role     UserRole @default(FAITHFUL)
  isActive Boolean  @default(true)
  
  // Force password change on first login
  forcePasswordChange Boolean @default(false)

  // Scope - Diocese vinculada (para DIOCESAN_ADMIN)
  dioceseId String?
  diocese   Diocese? @relation(fields: [dioceseId], references: [id])

  // Scope - Paróquia vinculada (para PARISH_ADMIN)
  parishId String?
  parish   Parish? @relation(fields: [parishId], references: [id])

  // Scope - Comunidade vinculada (para COMMUNITY_ADMIN)
  communityId String?
  community   Community? @relation("UserCommunity", fields: [communityId], references: [id])

  // 2FA
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret  String?

  // Refresh tokens
  refreshTokens RefreshToken[]

  // Relations - Many-to-many with communities
  communities UserCommunity[]

  // Primary community (for quick access)
  primaryCommunityId String?

  // Member profile (if user is a member/faithful)
  member Member?

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  lastLogin DateTime?

  @@index([email])
  @@index([role])
  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// Tabela de vínculos entre usuário e comunidade (Many-to-Many)
model UserCommunity {
  id String @id @default(cuid())

  // Relations
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Role específico nesta comunidade
  role UserRole

  // Status
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false) // Comunidade principal do usuário

  // Audit
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@index([isActive])
  @@map("user_communities")
}

// ============================================
// ECCLESIASTICAL STRUCTURE
// ============================================

model Diocese {
  id      String  @id @default(cuid())
  name    String
  address String
  city    String
  state   String
  zipCode String
  phone   String?
  email   String?
  website String?
  logoUrl String?

  // Responsible
  bishopName String?

  // Geolocation
  latitude  Float?
  longitude Float?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  parishes Parish[]
  users    User[] // DIOCESAN_ADMINs vinculados

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("dioceses")
}

model Parish {
  id      String  @id @default(cuid())
  name    String
  address String
  city    String
  state   String
  zipCode String
  phone   String?
  email   String?
  website String?
  logoUrl String?

  // Responsible
  priestName String?

  // Geolocation
  latitude  Float?
  longitude Float?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  dioceseId   String
  diocese     Diocese     @relation(fields: [dioceseId], references: [id], onDelete: Cascade)
  communities Community[]
  users       User[]      // PARISH_ADMIN vinculados a esta paróquia

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dioceseId])
  @@map("parishes")
}

model Community {
  id      String  @id @default(cuid())
  name    String
  address String
  city    String
  state   String
  zipCode String
  phone   String?
  email   String?
  website String?
  logoUrl String?

  // Responsible
  coordinatorName String?

  // Geolocation
  latitude  Float?
  longitude Float?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  parishId        String
  parish          Parish          @relation(fields: [parishId], references: [id], onDelete: Cascade)
  communityPastorals CommunityPastoral[]
  userCommunities UserCommunity[]
  users           User[]          @relation("UserCommunity") // COMMUNITY_ADMIN vinculados a esta comunidade
  members         Member[]
  events          Event[]
  massSchedules   MassSchedule[]
  massIntentions  MassIntention[]
  prayerRequests  PrayerRequest[]
  news            News[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parishId])
  @@map("communities")
}

// ============================================
// PASTORALS, MINISTRIES & MOVEMENTS
// ============================================

// Cadastro Global de Pastorais (criado por SYSTEM_ADMIN)
model GlobalPastoral {
  id          String  @id @default(cuid())
  name        String  @unique // Ex: "Liturgia", "Catequese", "Jovens"
  description String?
  mission     String?
  iconUrl     String?
  colorHex    String? // Cor para identificação visual

  // Metadata
  status EntityStatus @default(ACTIVE)

  // Relations - Vínculos hierárquicos
  diocesanPastorals DiocesanPastoral[]
  parishPastorals   ParishPastoral[]
  communityPastorals CommunityPastoral[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("global_pastorals")
}

// Pastoral vinculada à Diocese
model DiocesanPastoral {
  id          String  @id @default(cuid())
  description String?
  notes       String?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  globalPastoralId String
  globalPastoral   GlobalPastoral @relation(fields: [globalPastoralId], references: [id], onDelete: Cascade)
  dioceseId        String

  // Sub-vínculos
  parishPastorals ParishPastoral[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([globalPastoralId, dioceseId])
  @@index([dioceseId])
  @@map("diocesan_pastorals")
}

// Pastoral vinculada à Paróquia
model ParishPastoral {
  id          String  @id @default(cuid())
  description String?
  notes       String?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  globalPastoralId   String
  globalPastoral     GlobalPastoral    @relation(fields: [globalPastoralId], references: [id], onDelete: Cascade)
  diocesanPastoralId String?
  diocesanPastoral   DiocesanPastoral? @relation(fields: [diocesanPastoralId], references: [id], onDelete: SetNull)
  parishId           String

  // Sub-vínculos
  communityPastorals CommunityPastoral[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([globalPastoralId, parishId])
  @@index([parishId])
  @@map("parish_pastorals")
}

// Pastoral vinculada à Comunidade (nível operacional)
model CommunityPastoral {
  id          String  @id @default(cuid())
  description String?
  mission     String?
  photoUrl    String?
  notes       String?

  // Metadata
  foundedAt DateTime?
  status    EntityStatus @default(ACTIVE)

  // Relations
  globalPastoralId  String
  globalPastoral    GlobalPastoral  @relation(fields: [globalPastoralId], references: [id], onDelete: Cascade)
  parishPastoralId  String?
  parishPastoral    ParishPastoral? @relation(fields: [parishPastoralId], references: [id], onDelete: SetNull)
  communityId       String
  community         Community       @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Sub-grupos
  subGroups PastoralGroup[]

  // Membros
  members PastoralMember[]

  // Eventos (reuniões, atividades, missas, etc)
  eventPastorals EventPastoral[]

  // Histórico de coordenadores
  coordinatorHistory PastoralCoordinator[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([globalPastoralId, communityId])
  @@index([communityId])
  @@map("community_pastorals")
}

// Sub-grupos de uma Pastoral (ex: Liturgia → Coral, Ministros)
model PastoralGroup {
  id          String  @id @default(cuid())
  name        String  // Ex: "Coral", "Ministros da Eucaristia"
  description String?
  photoUrl    String?

  // Metadata
  status EntityStatus @default(ACTIVE)

  // Relations
  communityPastoralId String
  communityPastoral   CommunityPastoral @relation(fields: [communityPastoralId], references: [id], onDelete: Cascade)

  // Hierarquia de sub-grupos
  parentGroupId String?
  parentGroup   PastoralGroup? @relation("SubGroups", fields: [parentGroupId], references: [id], onDelete: SetNull)
  subGroups     PastoralGroup[] @relation("SubGroups")

  // Membros
  members PastoralMember[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityPastoralId])
  @@map("pastoral_groups")
}

// Membros de uma Pastoral ou Sub-grupo
model PastoralMember {
  id   String  @id @default(cuid())
  role String? // Ex: "Coordenador", "Vice-coordenador", "Membro"

  // Metadata
  isActive Boolean @default(true)

  // Relations
  communityPastoralId String?
  communityPastoral   CommunityPastoral? @relation(fields: [communityPastoralId], references: [id], onDelete: Cascade)
  pastoralGroupId     String?
  pastoralGroup       PastoralGroup?     @relation(fields: [pastoralGroupId], references: [id], onDelete: Cascade)
  memberId            String
  member              Member             @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Audit
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  @@index([communityPastoralId])
  @@index([pastoralGroupId])
  @@index([memberId])
  @@map("pastoral_members")
}

// Histórico de Coordenadores de uma Pastoral
model PastoralCoordinator {
  id String @id @default(cuid())

  // Relations
  communityPastoralId String
  communityPastoral   CommunityPastoral @relation(fields: [communityPastoralId], references: [id], onDelete: Cascade)
  memberId            String
  member              Member            @relation("PastoralCoordinators", fields: [memberId], references: [id], onDelete: Cascade)

  // Período de coordenação
  startDate DateTime
  endDate   DateTime?
  isCurrent Boolean   @default(false)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityPastoralId])
  @@index([memberId])
  @@map("pastoral_coordinators")
}



// ============================================
// MEMBERS & FAITHFUL
// ============================================

model Member {
  id String @id @default(cuid())

  // Personal Info
  fullName      String
  birthDate     DateTime?
  cpf           String?        @unique
  rg            String?
  gender        Gender?
  maritalStatus MaritalStatus?
  occupation    String?
  photoUrl      String?

  // Contact
  phone        String?
  email        String?
  zipCode      String?
  street       String?
  number       String?
  complement   String?
  neighborhood String?
  city         String?
  state        String?

  // Family
  fatherName String?
  motherName String?
  spouseId   String? @unique
  spouse     Member? @relation("Spouse", fields: [spouseId], references: [id])
  spouseOf   Member? @relation("Spouse")
  
  // Responsible (for minors without app access)
  responsibleId String?
  responsible   Member?  @relation("Responsible", fields: [responsibleId], references: [id])
  dependents    Member[] @relation("Responsible")

  // Status
  status MemberStatus @default(ACTIVE)

  // LGPD Consent
  consentGiven Boolean   @default(false)
  consentDate  DateTime?

  // Relations
  userId      String?   @unique
  user        User?     @relation(fields: [userId], references: [id])
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Pastorals
  pastoralMemberships       PastoralMember[]                @relation
  pastoralCoordinations     PastoralCoordinator[]           @relation("PastoralCoordinators")
  eventPastoralAssignments  EventPastoralAssignment[]       @relation("EventPastoralAssignments")

  // Sacraments
  sacraments Sacrament[]

  // Prayer Requests
  prayerRequests PrayerRequest[]

  // Schedule Assignments
  scheduleAssignments ScheduleAssignment[]

  // Event Participations
  eventParticipations EventParticipant[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([email])
  @@index([cpf])
  @@map("members")
}

model Sacrament {
  id       String        @id @default(cuid())
  type     SacramentType
  date     DateTime
  place    String?
  minister String? // Priest/Deacon name
  notes    String?

  // Relations
  memberId String
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([memberId])
  @@index([type])
  @@map("sacraments")
}

// ============================================
// EVENTS & CALENDAR
// ============================================

model Event {
  id             String    @id @default(cuid())
  title          String
  description    String?
  type           EventType
  startDate      DateTime
  endDate        DateTime?
  location       String?
  notes          String? // Notas adicionais
  isRecurring       Boolean          @default(false)
  recurrenceType    RecurrenceType?
  recurrenceInterval Int?            @default(1) // A cada X dias/semanas/meses
  recurrenceDays    String?          // JSON array de dias da semana [0-6] ou datas específicas
  recurrenceEndDate DateTime?        // Data de término da recorrência
  recurrenceRule    String?          // iCal RRULE format (opcional, para compatibilidade)

  // Metadata
  maxParticipants Int?
  isPublic        Boolean     @default(true)
  status          EventStatus @default(DRAFT)

  // Relations
  communityId  String
  community    Community            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  schedules    Schedule[]
  participants EventParticipant[]
  eventPastorals EventPastoral[] // Pastorais vinculadas ao evento

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([startDate])
  @@index([type])
  @@index([status])
  @@map("events")
}

model EventParticipant {
  id String @id @default(cuid())

  // Relations
  eventId  String
  event    Event   @relation(fields: [eventId], references: [id], onDelete: Cascade)
  memberId String
  member   Member  @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Metadata
  registeredAt DateTime @default(now())
  attended     Boolean  @default(false)
  notes        String?

  @@unique([eventId, memberId])
  @@index([eventId])
  @@index([memberId])
  @@map("event_participants")
}

model EventPastoral {
  id String @id @default(cuid())

  // Relations
  eventId             String
  event               Event             @relation(fields: [eventId], references: [id], onDelete: Cascade)
  communityPastoralId String
  communityPastoral   CommunityPastoral @relation(fields: [communityPastoralId], references: [id], onDelete: Cascade)

  // Metadata
  role     String? // Ex: "Responsável pela música", "Responsável pela liturgia"
  isLeader Boolean @default(false) // Pastoral principal/organizadora
  notes    String?

  // Escalas específicas desta pastoral neste evento
  assignments EventPastoralAssignment[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, communityPastoralId])
  @@index([eventId])
  @@index([communityPastoralId])
  @@map("event_pastorals")
}

model EventPastoralAssignment {
  id String @id @default(cuid())

  // Relations
  eventPastoralId String
  eventPastoral   EventPastoral @relation(fields: [eventPastoralId], references: [id], onDelete: Cascade)
  memberId        String
  member          Member        @relation("EventPastoralAssignments", fields: [memberId], references: [id], onDelete: Cascade)

  // Metadata
  role        String // Ex: "Ministro", "Leitor", "Cantor", "Violão"
  checkedIn   Boolean   @default(false)
  checkedInAt DateTime?
  notes       String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventPastoralId])
  @@index([memberId])
  @@map("event_pastoral_assignments")
}

// ============================================
// SCHEDULES & ASSIGNMENTS
// ============================================

model Schedule {
  id          String   @id @default(cuid())
  title       String
  description String?
  date        DateTime

  // Relations
  eventId     String
  event       Event                @relation(fields: [eventId], references: [id], onDelete: Cascade)
  assignments ScheduleAssignment[]

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([eventId])
  @@index([date])
  @@map("schedules")
}

model ScheduleAssignment {
  id          String    @id @default(cuid())
  role        String // e.g., "Leitor", "Ministro", "Acólito"
  checkedIn   Boolean   @default(false)
  checkedInAt DateTime?

  // Relations
  scheduleId String
  schedule   Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  memberId   String
  member     Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([scheduleId])
  @@index([memberId])
  @@map("schedule_assignments")
}

// ============================================
// MASS SCHEDULES
// ============================================

model MassSchedule {
  id          String           @id @default(cuid())
  dayOfWeek   Int // 0 = Sunday, 6 = Saturday
  time        String // HH:MM format
  type        MassScheduleType
  notes       String?
  isSpecial   Boolean          @default(false)
  specialDate DateTime?

  // Relations
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([dayOfWeek])
  @@map("mass_schedules")
}

// ============================================
// MASS INTENTIONS
// ============================================

model MassIntention {
  id            String        @id @default(cuid())
  intentionFor  String // Name of the person
  type          IntentionType
  requestedDate DateTime
  notes         String?

  // Payment
  amount        Float?
  isPaid        Boolean   @default(false)
  paidAt        DateTime?
  paymentMethod String?

  // Relations
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  requestedBy String // User email or name

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([requestedDate])
  @@map("mass_intentions")
}

// ============================================
// PRAYER REQUESTS
// ============================================

model PrayerRequest {
  id          String                @id @default(cuid())
  title       String
  description String
  category    PrayerRequestCategory
  isAnonymous Boolean               @default(false)
  status      PrayerRequestStatus   @default(PENDING)
  prayerCount Int                   @default(0)

  // Relations
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)
  memberId    String?
  member      Member?   @relation(fields: [memberId], references: [id], onDelete: SetNull)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([status])
  @@index([category])
  @@map("prayer_requests")
}

// ============================================
// NEWS & ANNOUNCEMENTS
// ============================================

model News {
  id          String   @id @default(cuid())
  title       String
  content     String
  category    String // "Aviso Urgente", "Notícia", "Evento", "Formação"
  imageUrl    String?
  isUrgent    Boolean  @default(false)
  publishedAt DateTime @default(now())

  // Relations
  communityId String
  community   Community @relation(fields: [communityId], references: [id], onDelete: Cascade)

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([communityId])
  @@index([publishedAt])
  @@index([category])
  @@map("news")
}

// ============================================
// FINANCIAL TRANSACTIONS
// ============================================

model FinancialTransaction {
  id          String          @id @default(cuid())
  type        TransactionType
  category    String
  amount      Float
  description String?
  date        DateTime

  // Bank account (optional)
  accountName String?

  // Relations
  communityId String?
  parishId    String?
  dioceseId   String?

  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
  @@index([date])
  @@index([communityId])
  @@map("financial_transactions")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id    String           @id @default(cuid())
  title String
  body  String
  type  NotificationType
  data  Json? // Additional data

  // Targeting
  userId      String?
  communityId String?
  parishId    String?
  dioceseId   String?

  // Status
  isSent Boolean   @default(false)
  sentAt DateTime?

  // Audit
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([isSent])
  @@index([type])
  @@map("notifications")
}
